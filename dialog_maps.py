#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–î–∏–∞–ª–æ–≥–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
–û–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º
"""

from dialog_dsl import DialogBuilder, Validators, InputType, DialogChain
from typing import Dict, Any
import sqlite3


# === –î–ï–ô–°–¢–í–ò–Ø –î–õ–Ø –î–ò–ê–õ–û–ì–û–í ===

async def save_user_registration(update, context, session):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    from bot import bot_instance
    
    user_data = {
        'telegram_id': session.user_id,
        'username': session.data.get('username', ''),
        'name': session.data['name'],
        'age': int(session.data['age']),
        'english_experience': session.data['experience'],
        'data_consent': True,
        'newsletter_consent': session.data.get('newsletter_consent', False)
    }
    
    bot_instance.save_user_data(user_data)
    return {"registration_completed": True}


async def send_documents(update, context, session):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    from dialog_config import FILES
    import os
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –°–ù–ê–û–ü
    snaop_file = FILES['snaop']
    if os.path.exists(snaop_file):
        await update.callback_query.message.reply_document(
            document=open(snaop_file, 'rb'),
            caption="üìÑ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
        )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è
    if session.data.get('newsletter_consent'):
        consent_file = FILES['newsletter_consent']
        if os.path.exists(consent_file):
            await update.callback_query.message.reply_document(
                document=open(consent_file, 'rb'),
                caption="üìÑ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏"
            )
    
    return {}


async def check_manager_password(update, context, session):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    from auth_manager import auth_manager
    
    password = session.data.get('password', '')
    user_id = session.user_id
    
    if auth_manager.authenticate(user_id, password):
        return {"authenticated": True}
    else:
        return {"authenticated": False, "error": "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"}


async def export_users_data(update, context, session):
    """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    from manager_interface import ManagerInterface
    
    # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
    return {"export_completed": True}


# === –î–ò–ê–õ–û–ì–û–í–´–ï –ö–ê–†–¢–´ ===

def create_user_registration_dialog() -> DialogChain:
    """–î–∏–∞–ª–æ–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return (DialogBuilder("user_registration", "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", 
                         "–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫–ª—É–±–∞")
            .start_with("welcome_step")
            
            # 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
            .add_choice(
                step_id="welcome_step",
                message=(
                    "üá¨üáß <b>–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∫–ª—É–±!</b>\n\n"
                    "–î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\n\n"
                    "–ù–æ —Å–Ω–∞—á–∞–ª–∞ –º–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:"
                ),
                inline_keyboard=[
                    [("‚úÖ –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö", "data_consent_yes")],
                    [("‚ùå –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω", "data_consent_no")]
                ],
                next_step="check_consent_step"
            )
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
            .add_action(
                step_id="check_consent_step",
                action=lambda u, c, s: {"data_consent": s.data.get('welcome') == "data_consent_yes"},
                next_step="consent_result_step"
            )
            .add_condition("check_consent_step", {
                "data_consent==True": "name_question_step",
                "data_consent==False": "consent_denied_step"
            })
            
            # 3a. –°–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—É—á–µ–Ω–æ - –∑–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏
            .add_question(
                step_id="name_question_step",
                message=(
                    "‚úÖ <b>–û—Ç–ª–∏—á–Ω–æ! –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω–æ.</b>\n\n"
                    "–¢–µ–ø–µ—Ä—å —Å–∫–∞–∂–∏, –∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? üòä"
                ),
                input_type=InputType.TEXT,
                validations=[
                    Validators.not_empty(),
                    Validators.min_length(2),
                    Validators.max_length(100)
                ],
                next_step="experience_question_step"
            )
            
            # 3b. –°–æ–≥–ª–∞—Å–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
            .add_final(
                step_id="consent_denied_step",
                message=(
                    "‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö —è –Ω–µ –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.\n\n"
                    "–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ /start —Å–Ω–æ–≤–∞! üòä"
                )
            )
            
            # 4. –í–æ–ø—Ä–æ—Å –æ–± –æ–ø—ã—Ç–µ –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
            .add_choice(
                step_id="experience_question_step",
                message="–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, <b>{name}</b>! üòä\n\n–¢—ã —É–∂–µ –∏–∑—É—á–∞–ª –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ä–∞–Ω—å—à–µ?",
                inline_keyboard=[
                    [("‚úÖ –î–∞, –∏–∑—É—á–∞–ª –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "experience_yes")],
                    [("‚ùå –ù–µ—Ç, —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—é", "experience_no")]
                ],
                next_step="age_question_step"
            )
            
            # 5. –í–æ–ø—Ä–æ—Å –æ –≤–æ–∑—Ä–∞—Å—Ç–µ
            .add_question(
                step_id="age_question_step",
                message=(
                    "{'–û—Ç–ª–∏—á–Ω–æ! üëç' if experience == 'experience_yes' else '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –í—Å–µ –∫–æ–≥–¥–∞-—Ç–æ –Ω–∞—á–∏–Ω–∞–ª–∏! üåü'}\n\n"
                    "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç? (–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ü–∏—Ñ—Ä—É)"
                ),
                input_type=InputType.NUMBER,
                validations=[
                    Validators.is_number(),
                    Validators.age_range(5, 100)
                ],
                next_step="newsletter_question_step"
            )
            
            # 6. –í–æ–ø—Ä–æ—Å –æ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
            .add_choice(
                step_id="newsletter_question_step",
                message=(
                    "–û—Ç–ª–∏—á–Ω–æ, {name}! üéâ\n\n"
                    "<b>–í–∫–ª—é—á–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —ç—Ç–æ–º –±–æ—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–º –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏, "
                    "–ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–æ–Ω—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–ª—É–±–∞!</b>\n\n"
                    "–î–ª—è —ç—Ç–æ–≥–æ:\n"
                    "1. –ù–∞–∂–º–∏ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –≤–≤–µ—Ä—Ö—É —á–∞—Ç–∞\n"
                    "2. –í–∫–ª—é—á–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è üîî\n\n"
                    "–ò –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å:"
                ),
                inline_keyboard=[
                    [("‚úÖ –î–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É", "newsletter_yes")],
                    [("‚ùå –ù–µ —Ö–æ—á—É –ø–æ–ª—É—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", "newsletter_no")]
                ],
                next_step="save_registration_step"
            )
            
            # 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            .add_action(
                step_id="save_registration_step",
                action=save_user_registration,
                next_step="send_documents_step"
            )
            
            # 8. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            .add_action(
                step_id="send_documents_step",
                action=send_documents,
                next_step="registration_complete_step"
            )
            
            # 9. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            .add_final(
                step_id="registration_complete_step",
                message=(
                    "{'‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢—ã –±—É–¥–µ—à—å –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∞–Ω–æ–Ω—Å—ã!' if newsletter_consent else '‚úÖ –•–æ—Ä–æ—à–æ, —Ä–∞—Å—Å—ã–ª–∫—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ –±—É–¥—É.'}\n\n"
                    "üéâ <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
                    "<b>–¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:</b>\n"
                    "‚Ä¢ –ò–º—è: {name}\n"
                    "‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: {age} –ª–µ—Ç\n"
                    "‚Ä¢ –û–ø—ã—Ç –∏–∑—É—á–µ–Ω–∏—è: {'–î–∞' if experience == 'experience_yes' else '–ù–µ—Ç'}\n"
                    "‚Ä¢ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –¥–∞–Ω–Ω—ã–µ: ‚úÖ\n"
                    "‚Ä¢ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É: {'‚úÖ' if newsletter_consent else '‚ùå'}\n\n"
                    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∫–ª—É–±! üá¨üáß\n"
                    "–°–∫–æ—Ä–æ —Ç—ã –ø–æ–ª—É—á–∏—à—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–Ω—è—Ç–∏—è—Ö! üìö"
                )
            )
            
            .set_timeout(1800)  # 30 –º–∏–Ω—É—Ç –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
            .build())


def create_manager_auth_dialog() -> DialogChain:
    """–î–∏–∞–ª–æ–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    return (DialogBuilder("manager_auth", "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞",
                         "–ü—Ä–æ—Ü–µ—Å—Å –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
            .start_with("request_password_step")
            
            # 1. –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è
            .add_question(
                step_id="request_password_step",
                message=(
                    "üîê <b>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</b>\n\n"
                    "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
                ),
                input_type=InputType.TEXT,
                validations=[Validators.not_empty()],
                next_step="check_password_step"
            )
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            .add_action(
                step_id="check_password_step",
                action=check_manager_password,
                next_step="password_result_step"
            )
            .add_condition("check_password_step", {
                "authenticated==True": "auth_success_step",
                "authenticated==False": "auth_failed_step"
            })
            
            # 3a. –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            .add_final(
                step_id="auth_success_step",
                message=(
                    "‚úÖ <b>–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω!</b>\n\n"
                    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."
                )
            )
            
            # 3b. –ù–µ—É–¥–∞—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            .add_final(
                step_id="auth_failed_step",
                message="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω."
            )
            
            .set_timeout(300)  # 5 –º–∏–Ω—É—Ç –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            .set_permissions(["manager"])
            .build())


def create_broadcast_dialog() -> DialogChain:
    """–î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏"""
    return (DialogBuilder("manager_broadcast", "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏",
                         "–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏")
            .start_with("request_message_step")
            
            # 1. –ó–∞–ø—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
            .add_question(
                step_id="request_message_step",
                message=(
                    "üì¢ <b>–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</b>\n\n"
                    "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, "
                    "—Å–æ–≥–ª–∞—Å–∏–≤—à–∏–º—Å—è –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:"
                ),
                input_type=InputType.TEXT,
                validations=[
                    Validators.not_empty(),
                    Validators.max_length(4000)
                ],
                next_step="confirm_broadcast_step"
            )
            
            # 2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
            .add_choice(
                step_id="confirm_broadcast_step",
                message=(
                    "üì¢ <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</b>\n\n"
                    "<b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n{request_message}\n\n"
                    "<b>–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</b> {recipients_count}\n\n"
                    "–û—Ç–ø—Ä–∞–≤–∏—Ç—å?"
                ),
                inline_keyboard=[
                    [("üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", "broadcast_confirm")],
                    [("‚ùå –û—Ç–º–µ–Ω–∞", "broadcast_cancel")]
                ],
                next_step="broadcast_result_step"
            )
            .add_condition("confirm_broadcast_step", {
                "confirm_broadcast=='broadcast_confirm'": "send_broadcast_step",
                "confirm_broadcast=='broadcast_cancel'": "broadcast_cancelled_step"
            })
            
            # 3a. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
            .add_action(
                step_id="send_broadcast_step",
                action=lambda u, c, s: {"broadcast_sent": True, "sent_count": 42},  # –ó–∞–≥–ª—É—à–∫–∞
                message="üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏—è...",
                next_step="broadcast_success_step"
            )
            
            # 3b. –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
            .add_final(
                step_id="broadcast_cancelled_step",
                message="‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
            )
            
            # 4. –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
            .add_final(
                step_id="broadcast_success_step",
                message="‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent_count} —Å–æ–æ–±—â–µ–Ω–∏–π"
            )
            
            .set_timeout(600)  # 10 –º–∏–Ω—É—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
            .set_permissions(["manager"])
            .build())


def create_user_profile_edit_dialog() -> DialogChain:
    """–î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return (DialogBuilder("user_profile_edit", "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è",
                         "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            .start_with("choose_field_step")
            
            # 1. –í—ã–±–æ—Ä –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            .add_choice(
                step_id="choose_field_step",
                message=(
                    "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</b>\n\n"
                    "–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"
                ),
                inline_keyboard=[
                    [("üë§ –ò–º—è", "edit_name")],
                    [("üéÇ –í–æ–∑—Ä–∞—Å—Ç", "edit_age")],
                    [("üìö –û–ø—ã—Ç –∏–∑—É—á–µ–Ω–∏—è", "edit_experience")],
                    [("üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏", "edit_newsletter")],
                    [("‚ùå –û—Ç–º–µ–Ω–∞", "edit_cancel")]
                ],
                next_step="edit_field_step"
            )
            .add_condition("choose_field_step", {
                "choose_field=='edit_name'": "edit_name_step",
                "choose_field=='edit_age'": "edit_age_step",
                "choose_field=='edit_experience'": "edit_experience_step",
                "choose_field=='edit_newsletter'": "edit_newsletter_step",
                "choose_field=='edit_cancel'": "edit_cancelled_step"
            })
            
            # 2a. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏
            .add_question(
                step_id="edit_name_step",
                message="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:",
                input_type=InputType.TEXT,
                validations=[
                    Validators.not_empty(),
                    Validators.min_length(2),
                    Validators.max_length(100)
                ],
                next_step="save_changes_step"
            )
            
            # 2b. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
            .add_question(
                step_id="edit_age_step",
                message="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –≤–æ–∑—Ä–∞—Å—Ç:",
                input_type=InputType.NUMBER,
                validations=[
                    Validators.is_number(),
                    Validators.age_range(5, 100)
                ],
                next_step="save_changes_step"
            )
            
            # 2c. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—ã—Ç–∞
            .add_choice(
                step_id="edit_experience_step",
                message="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –æ–ø—ã—Ç –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ:",
                inline_keyboard=[
                    [("‚úÖ –î–∞, –∏–∑—É—á–∞–ª –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "experience_yes")],
                    [("‚ùå –ù–µ—Ç, —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—é", "experience_no")]
                ],
                next_step="save_changes_step"
            )
            
            # 2d. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—Å—ã–ª–∫–∏
            .add_choice(
                step_id="edit_newsletter_step",
                message="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏:",
                inline_keyboard=[
                    [("‚úÖ –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", "newsletter_on")],
                    [("‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", "newsletter_off")]
                ],
                next_step="save_changes_step"
            )
            
            # 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            .add_action(
                step_id="save_changes_step",
                action=lambda u, c, s: {"changes_saved": True},  # –ó–∞–≥–ª—É—à–∫–∞
                next_step="changes_saved_step"
            )
            
            # 4a. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            .add_final(
                step_id="changes_saved_step",
                message="‚úÖ <b>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</b>\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω."
            )
            
            # 4b. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
            .add_final(
                step_id="edit_cancelled_step",
                message="‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
            )
            
            .set_timeout(600)  # 10 –º–∏–Ω—É—Ç –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            .build())


def create_user_support_dialog() -> DialogChain:
    """–î–∏–∞–ª–æ–≥ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"""
    return (DialogBuilder("user_support", "–û–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É",
                         "–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏")
            .start_with("support_category_step")
            
            # 1. –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
            .add_choice(
                step_id="support_category_step",
                message=(
                    "üìû <b>–û–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</b>\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:"
                ),
                inline_keyboard=[
                    [("üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞", "tech_support")],
                    [("üìö –í–æ–ø—Ä–æ—Å –æ–± –æ–±—É—á–µ–Ω–∏–∏", "learning_support")],
                    [("üí∞ –í–æ–ø—Ä–æ—Å –æ–± –æ–ø–ª–∞—Ç–µ", "payment_support")],
                    [("üìù –î—Ä—É–≥–æ–µ", "other_support")],
                    [("‚ùå –û—Ç–º–µ–Ω–∞", "support_cancel")]
                ],
                next_step="support_message_step"
            )
            .add_condition("support_category_step", {
                "support_category=='support_cancel'": "support_cancelled_step"
            })
            
            # 2. –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
            .add_question(
                step_id="support_message_step",
                message=(
                    "–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–æ.\n"
                    "–ß–µ–º –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –º—ã —Å–º–æ–∂–µ–º –ø–æ–º–æ—á—å:"
                ),
                input_type=InputType.TEXT,
                validations=[
                    Validators.not_empty(),
                    Validators.min_length(10),
                    Validators.max_length(2000)
                ],
                next_step="send_support_request_step"
            )
            
            # 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è
            .add_action(
                step_id="send_support_request_step",
                action=lambda u, c, s: {"ticket_id": f"TICKET_{int(time.time())}"},
                next_step="support_sent_step"
            )
            
            # 4a. –û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            .add_final(
                step_id="support_sent_step",
                message=(
                    "‚úÖ <b>–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</b>\n\n"
                    "–ù–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è: {ticket_id}\n"
                    "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {support_category}\n\n"
                    "–ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.\n"
                    "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! üôè"
                )
            )
            
            # 4b. –û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
            .add_final(
                step_id="support_cancelled_step",
                message="‚ùå –û–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç–º–µ–Ω–µ–Ω–æ"
            )
            
            .set_timeout(900)  # 15 –º–∏–Ω—É—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
            .build())


# === –î–ò–ê–õ–û–ì–û–í–ê–Ø –ö–ê–†–¢–ê ===

class DialogMap:
    """–ö–∞—Ä—Ç–∞ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã"""
    
    def __init__(self):
        self.user_dialogs = {
            "registration": create_user_registration_dialog(),
            "profile_edit": create_user_profile_edit_dialog(),
            "support": create_user_support_dialog(),
        }
        
        self.manager_dialogs = {
            "auth": create_manager_auth_dialog(),
            "broadcast": create_broadcast_dialog(),
        }
        
        # –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏
        self.dialog_transitions = {
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
            "user_menu": {
                "profile": "profile_edit",
                "support": "support",
                "settings": None  # –ü—Ä—è–º–æ–µ –º–µ–Ω—é –±–µ–∑ –¥–∏–∞–ª–æ–≥–∞
            },
            
            # –ú–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã  
            "manager_menu": {
                "broadcast": "broadcast",
                "stats": None,  # –ü—Ä—è–º–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                "users": None,  # –ü—Ä—è–º–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                "export": None  # –ü—Ä—è–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
            }
        }
        
        # –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –≤ –¥–∏–∞–ª–æ–≥–∏
        self.entry_points = {
            # –ö–æ–º–∞–Ω–¥—ã
            "/start": ("registration", "user"),
            "/manager": ("auth", "manager"),
            
            # Callback –¥–∞–Ω–Ω—ã–µ
            "user_edit_profile": ("profile_edit", "user"),
            "user_support": ("support", "user"),
            "mgr_broadcast": ("broadcast", "manager"),
        }
    
    def get_dialog_by_entry(self, entry_point: str) -> Tuple[Optional[DialogChain], str]:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ª–æ–≥ –ø–æ —Ç–æ—á–∫–µ –≤—Ö–æ–¥–∞"""
        if entry_point in self.entry_points:
            dialog_id, user_type = self.entry_points[entry_point]
            
            if user_type == "user" and dialog_id in self.user_dialogs:
                return self.user_dialogs[dialog_id], user_type
            elif user_type == "manager" and dialog_id in self.manager_dialogs:
                return self.manager_dialogs[dialog_id], user_type
        
        return None, ""
    
    def get_all_dialogs(self) -> Dict[str, DialogChain]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏"""
        all_dialogs = {}
        all_dialogs.update(self.user_dialogs)
        all_dialogs.update(self.manager_dialogs)
        return all_dialogs


# === –î–ò–ê–ì–†–ê–ú–ú–ê –°–û–°–¢–û–Ø–ù–ò–ô ===

DIALOG_STATE_DIAGRAM = """
–î–∏–∞–ª–æ–≥–æ–≤–∞—è –∫–∞—Ä—Ç–∞ Telegram-–±–æ—Ç–∞ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∫–ª—É–±–∞

=== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –î–ò–ê–õ–û–ì–ò ===

1. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø (/start)
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ   –°—Ç–∞—Ä—Ç     ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     –ù–ï–¢    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –°–æ–≥–ª–∞—Å–∏–µ   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  –û—Ç–∫–∞–∑       ‚îÇ
   ‚îÇ  –Ω–∞ –¥–∞–Ω–Ω—ã–µ  ‚îÇ            ‚îÇ  (–ö–û–ù–ï–¶)     ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ –î–ê
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –í–≤–æ–¥ –∏–º–µ–Ω–∏ ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ   –û–ø—ã—Ç      ‚îÇ
   ‚îÇ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –í–≤–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç–∞‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –°–æ–≥–ª–∞—Å–∏–µ   ‚îÇ
   ‚îÇ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ  ‚îÇ
   ‚îÇ   –¥–∞–Ω–Ω—ã—Ö    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞   ‚îÇ
   ‚îÇ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ  ‚îÇ
   ‚îÇ  (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

2. –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –í—ã–±–æ—Ä –ø–æ–ª—è  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –í–≤–æ–¥ –Ω–æ–≤–æ–≥–æ ‚îÇ
   ‚îÇ  –∑–Ω–∞—á–µ–Ω–∏—è   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ  ‚îÇ
   ‚îÇ  (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

3. –û–ë–†–ê–©–ï–ù–ò–ï –í –ü–û–î–î–ï–†–ñ–ö–£
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ   –í—ã–±–æ—Ä     ‚îÇ
   ‚îÇ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ    –í–≤–æ–¥     ‚îÇ
   ‚îÇ  —Å–æ–æ–±—â–µ–Ω–∏—è  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞   ‚îÇ
   ‚îÇ  (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

=== –ú–ï–ù–ï–î–ñ–ï–†–°–ö–ò–ï –î–ò–ê–õ–û–ì–ò ===

1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (/manager)
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –ó–∞–ø—Ä–æ—Å      ‚îÇ
   ‚îÇ –ø–∞—Ä–æ–ª—è      ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     –ù–ï–¢    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    –û—Ç–∫–∞–∑     ‚îÇ
   ‚îÇ  –ø–∞—Ä–æ–ª—è     ‚îÇ            ‚îÇ   (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ –î–ê
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ   –î–æ—Å—Ç—É–ø    ‚îÇ
   ‚îÇ —Ä–∞–∑—Ä–µ—à–µ–Ω    ‚îÇ
   ‚îÇ  (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

2. –°–û–ó–î–ê–ù–ò–ï –†–ê–°–°–´–õ–ö–ò
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ    –í–≤–æ–¥     ‚îÇ
   ‚îÇ —Å–æ–æ–±—â–µ–Ω–∏—è   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     –ù–ï–¢    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   –û—Ç–º–µ–Ω–∞     ‚îÇ
   ‚îÇ  —Ä–∞—Å—Å—ã–ª–∫–∏   ‚îÇ            ‚îÇ  (–ö–û–ù–ï–¶)     ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ –î–ê
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç   ‚îÇ
   ‚îÇ  (–ö–û–ù–ï–¶)    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

=== –ú–ï–•–ê–ù–ò–ó–ú –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ===

–ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –≤ –¥–∏–∞–ª–æ–≥–µ:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –û–®–ò–ë–ö–ê    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚îÇ
‚îÇ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í—ã–±–æ—Ä:     ‚îÇ
‚îÇ 1. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å‚îÇ
‚îÇ 2. –ù–∞—á–∞—Ç—å   ‚îÇ
‚îÇ    –∑–∞–Ω–æ–≤–æ   ‚îÇ
‚îÇ 3. –û—Ç–º–µ–Ω–∏—Ç—å ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

=== –°–û–°–¢–û–Ø–ù–ò–Ø –°–ï–°–°–ò–ô ===

STARTED ‚îÄ‚îÄ‚ñ∫ IN_PROGRESS ‚îÄ‚îÄ‚ñ∫ WAITING_INPUT ‚îÄ‚îÄ‚ñ∫ COMPLETED
    ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
    ‚ñº              ‚ñº              ‚ñº              ‚îÇ
  ERROR ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ERROR ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ERROR             ‚îÇ
    ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
    ‚ñº              ‚ñº              ‚ñº              ‚îÇ
 PAUSED ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ PAUSED ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ PAUSED              ‚îÇ
    ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
    ‚ñº              ‚ñº              ‚ñº              ‚îÇ
CANCELLED ‚óÑ‚îÄ‚îÄ CANCELLED ‚óÑ‚îÄ‚îÄ CANCELLED ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
"""


# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –¥–∏–∞–ª–æ–≥–æ–≤
dialog_map = DialogMap()